image: node:16

cache:
  key: $CI_PROJECT_ID
  paths:
    - .yarn/cache
    - tmp/

variables:
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_HOST: tcp://docker:2376

default:
  before_script:
    - yarn --immutable
    - yarn run t10s:compile

stages:
  - build
  - bake

services:
  - docker:20.10.17-dind

build:
  stage: build
  script:
    - yarn run build:bundle
    - yarn run build:shared
  artifacts:
    paths:
      - dist

codeQuality:
  stage: build
  script:
    - echo "${CI_COMMIT_MESSAGE}" | npx commitlint
    - yarn run lint:code
    - yarn run t10s:lint

test:
  stage: build
  script:
    - ./node_modules/.bin/jest -w 2 --coverage --coverageReporters="text-summary" --no-cache
  coverage: '/Lines.+\d+.\d+%/'

bake:
  stage: bake
  image: docker:20.10.17
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  needs:
    - build
  script:
    - apk add git
    - git describe --always > ./client_version.txt
    - docker build --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --tag $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
